\documentclass[11pt, oneside]{book}
\usepackage{geometry}
\geometry{a4paper}

\usepackage{CJKutf8}

\usepackage{graphicx}
\usepackage{indentfirst}
\usepackage[colorlinks,urlcolor=blue]{hyperref}

\usepackage{listings}
\lstset{basicstyle=\ttfamily}

\newcommand{\qpar}[1]{
\vspace{0.25em}
\noindent
#1\par
\vspace{0.25em}
}

\newcommand{\qurl}[1]{\url{#1}}

\newcommand{\qqbox}[1]{\hspace{0.2em}\fbox{#1}\hspace{0.2em}}

\newcommand{\qtable}[1]{\vspace{0.5em}#1\vspace{0.5em}}

\title{七牛云处理服务使用指南}
\author{梁涛 \\ @七牛云存储}
\date{2013-08-19}

\begin{document}

\begin{CJK*}{UTF8}{song}
\maketitle

\chapter{图片处理}

\section{获取图片信息}

\subsection{获取基本信息}

\qpar{在图片下载URL后附加\qqbox{imageInfo}指示符（区分大小写），可以获取JSON格式的图片基本信息，包括图片格式、宽高值（单位：像素）、色彩模型。}
\qpar{注意：缩略图不支持该方法。}

\qpar{示例：}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
\qpar{$\Rightarrow$}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageInfo}}

\qpar{返回结果：}
\begin{verbatim}
{
   "format":     "jpeg",
   "width":      640,     // 像素
   "height":     427,     // 像素
   "colorModel": "ycbcr"
}
\end{verbatim}

\clearpage

\subsection{获取EXIF信息}

\qpar{EXIF（EXchangeable Image File Format），是专门为数码相机的照片设定的可交换图像文件格式，
详见\href{http://zh.wikipedia.org/wiki/EXIF}{维基百科}。}
\qpar{获取方式为在图片下载URL后附加\qqbox{exif}指示符（区分大小写）。}
\qpar{注意：缩略图不支持该方法。}

\qpar{示例：}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
\qpar{$\Rightarrow$}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?exif}}

\qpar{返回结果：}
\begin{verbatim}
{
   "DateTime" : {
      "type" : 2,
      "val" : "2011:11:19 17:09:23"
   },
   "ExposureBiasValue" : {
      "type" : 10,
      "val" : "0.33 EV"
   },
   "ExposureTime" : {
      "type" : 5,
      "val" : "1/50 sec."
   },
   "Model" : {
      "type" : 2,
      "val" : "Canon EOS 600D"
   },
   "ISOSpeedRatings" : {
      "type" : 3,
      "val" : "3200"
   },
   "ResolutionUnit" : {
      "type" : 3,
      "val" : "英寸"
   },
   ...其余略...
}
\end{verbatim}

\clearpage

\section{生成缩略图}

\qpar{在图片下载URL后附加\qqbox{imageView}指示符（区分大小写）并指定缩略规格，可以生成该图片的缩略图。}
\qpar{调用接口：}
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
<URL>?imageView/<Mode>/w/<Width>/h/<Height>/q/<Quality>/format/<Format>
\end{lstlisting}

%\begin{verbatim}
%<URL>?imageView/<Mode>/w/<Width>/h/<Height>/q/<Quality>/format/<Format>
%     |________||_____||________||_________||__________||______________|
%          |       |        |         |           |            |
% 指示符 --+       |        |         |           |            |
%                  |        |         |           |            |
% 缩略模式 --------+        |         |           |            |
%                           |         |           |            |
% 缩略宽度（像素） ---------+         |           |            |
%                                     |           |            |
% 缩略高度（像素） -------------------+           |            |
%                                                 |            |
% 缩略质量（取值1-100） --------------------------+            |
%                                                              |
% 图片格式（支持jpg、gif、webp等） ----------------------------+
%\end{verbatim}

\qpar{参数说明：}
\qtable{
\def\arraystretch{1.5}
\begin{tabular}{|l|l|l|}
\hline
名称 & 说明 & 备注\\
\hline
\textless Mode\textgreater & 处理模式 & \\
\hline
\textless Width\textgreater & 缩略宽度，单位：像素（px） & \\
\hline
\textless Height\textgreater & 缩略高度，单位：像素（px） & \\
\hline
\textless Quality\textgreater & 图片质量，取值范围1－100 & 可选，缺省为85 \\
\hline
\textless Format\textgreater & 图片格式，支持jpg、gif、png、webp等 & 可选，缺省为原图格式 \\
\hline
\end{tabular}
}

\qpar{其中\textless mode\textgreater分为如下4种情况：}
\qtable{
\def\arraystretch{1.5}
\begin{tabular}{|l|p{22em}|l|}
\hline
模式 & 说明 & 备注 \\
\hline
\textless mode\textgreater=1 & 同时指定宽度和高度，等比裁剪原图正中部分并缩小为\textless width\textgreater x\textless height\textgreater 大小的缩略图。& 参看示例1 \\
\hline
\textless mode\textgreater=2 & 同时指定宽度和高度，原图缩小为不超出\textless width\textgreater x\textless height\textgreater 大小的缩略图，避免裁剪长边。& 参看示例2 \\
\hline
\textless mode\textgreater=2 & 仅指定宽度，高度等比缩小。 & 参看示例2 \\
\hline
\textless mode\textgreater=2 & 仅指定高度，宽度等比缩小。 & 参看示例3 \\
\hline
\end{tabular}
}

\clearpage

\qpar{示例1，裁剪正中部分，等比缩小生成200x200缩略图：}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
\qpar{$\Rightarrow$}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/1/w/200/h/200}}

\begin{center}
\includegraphics[scale=0.65]{../pics/gogopher_imageView_1_200x200.jpg}
\end{center}

\qpar{示例2，宽度固定为200px，高度等比缩小，生成200x133缩略图：}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
\qpar{$\Rightarrow$}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/w/200/h/200}}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/w/200}}

\begin{center}
\includegraphics[scale=0.65]{../pics/gogopher_imageView_2_200x200.jpg}
\end{center}

\clearpage

\qpar{示例3，高度固定为200px，宽度等比缩小，生成300x200缩略图：}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
\qpar{$\Rightarrow$}
\qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/h/200}}

\begin{center}
\includegraphics[scale=0.65]{../pics/gogopher_imageView_2_x200.jpg}
\end{center}

\clearpage

\section{高级图片处理}

\qpar{除了能方便地生成缩略图外，七牛云处理服务还提供其它高级图片处理功能，包括缩略、裁剪、旋转等等。}
\qpar{调用接口：}
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
<URL>?imageMogr/v2/auto-orient
                  /thumbnail/<ImageSize>
                  /gravity/<GravityType>
                  /crop/<ImageSizeAndOffset>
                  /quality/<Quality>
                  /rotate/<Degree>
                  /format/<Format>
\end{lstlisting}

\qpar{参数说明：}
\qtable{
\def\arraystretch{1.5}
\footnotesize
\begin{tabular}{|l|p{18em}|p{10em}|}
\hline
名称 & 说明 & 备注\\
\hline
\textless ImageSize\textgreater & 缩略图规格，参见规格说明表 & 可选，缺省为不缩略 \\
\hline
\textless GravityType\textgreater & 位置偏移，只会影响其后的裁剪偏移(Offset)，可选值参看位置偏移取值表 & 可选，缺省为左上角（NorthWest） \\
\hline
\textless ImageSizeAndOffset\textgreater & 裁剪规格，参见规格说明表 & 可选，缺省为不裁剪 \\
\hline
\textless Quality\textgreater & 图片质量，取值范围1－100 & 可选，缺省为85 \\
\hline
\textless Degree\textgreater & 旋转角度，取值范围1－360 & 可选，缺省为不旋转 \\
\hline
\textless Format\textgreater & 图片格式，支持jpg、gif、png、webp等 & 可选，缺省为原图格式 \\
\hline
\end{tabular}
}

\qpar{位置偏移取值表：}
\qtable{
\footnotesize
\begin{tabular}[t]{|l|c|r|}
\hline
\parbox[t][6em]{6em}{NorthWest} & \parbox[t][6em]{6em}{\makebox[6em][c]{North}} & \parbox[t][6em]{6em}{\makebox[6em][r]{NorthEast}} \\
\hline
\parbox[c][6em]{6em}{West} & \parbox[c][6em]{6em}{\makebox[6em][c]{Center}} & \parbox[c][6em]{6em}{\makebox[6em][r]{East}} \\
\hline
\parbox[b][6em]{6em}{SouthWest} & \parbox[b][6em]{6em}{\makebox[6em][c]{South}} & \parbox[b][6em]{6em}{\makebox[6em][r]{SouthEast}} \\
\hline
\end{tabular}
}

\end{CJK*}

\end{document}
