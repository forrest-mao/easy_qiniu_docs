\documentclass[11pt, oneside]{book}
\usepackage{geometry}
\geometry{a4paper}

\usepackage{CJKutf8}

\usepackage{graphicx}
\usepackage{indentfirst}
\usepackage[colorlinks,urlcolor=blue]{hyperref}

\usepackage{listings}
\lstset{basicstyle=\ttfamily}

\usepackage{float}
\usepackage{color}

\newcommand{\qpar}[1]{
\vspace{0.25em}
\noindent
#1\par
\vspace{0.25em}
}

\newcommand{\qurl}[1]{\url{#1}}
\newcommand{\qqbox}[1]{\hspace{0.2em}\fbox{#1}\hspace{0.2em}}
\newcommand{\qtable}[1]{\footnotesize\vspace{0.5em}#1\vspace{0.5em}\normalsize}

\floatstyle{ruled}
\newfloat{sample}{H}{sample}[chapter]
\floatname{sample}{示例}

\setlength{\textheight}{680pt}

\title{七牛云处理服务使用指南 \\ 图片处理部分}
\author{梁涛 \\ @七牛云存储}
\date{2013-08-19}

\begin{document}

\begin{CJK*}{UTF8}{song}
\maketitle
\tableofcontents

\chapter{图片处理}

\section{获取图片信息}

\subsection{基本信息}

\qpar{在图片下载URL后附加\qqbox{imageInfo}指示符（区分大小写），可以获取JSON格式的图片基本信息，包括图片格式、宽高值（单位：像素）、色彩模型。\textcolor{red}{注意：缩略图不支持该方法。}}

\begin{sample}
  \caption{获取图片基本信息}

    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageInfo}}

    \qpar{返回结果：}
\begin{verbatim}
{
   "format":     "jpeg",
   "width":      640,     // 像素
   "height":     427,     // 像素
   "colorModel": "ycbcr"
}
\end{verbatim}

  \label{imageInfo}
\end{sample}

\subsection{EXIF信息}

\qpar{EXIF（EXchangeable Image File Format），是专门为数码相机的照片设定的可交换图像文件格式，
详见\href{http://zh.wikipedia.org/wiki/EXIF}{维基百科}。}
\qpar{获取方式为在图片下载URL后附加\qqbox{exif}指示符（区分大小写）。\textcolor{red}{注意：缩略图不支持该方法。}}

\begin{sample}
  \caption{获取图片EXIF信息}

    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?exif}}

    \qpar{返回结果：}
\begin{verbatim}
{
   "DateTime" : {
      "type" : 2,
      "val" : "2011:11:19 17:09:23"
   },
   "ExposureBiasValue" : {
      "type" : 10,
      "val" : "0.33 EV"
   },
   "ExposureTime" : {
      "type" : 5,
      "val" : "1/50 sec."
   },
   "Model" : {
      "type" : 2,
      "val" : "Canon EOS 600D"
   },
   "ISOSpeedRatings" : {
      "type" : 3,
      "val" : "3200"
   },
   "ResolutionUnit" : {
      "type" : 3,
      "val" : "英寸"
   },
   ...其余略...
}
\end{verbatim}
  \label{exif}
\end{sample}

\clearpage

\section{生成缩略图}

\qpar{在图片下载URL后附加\qqbox{imageView}指示符（区分大小写）并指定缩略规格，可以生成该图片的缩略图。}
\qpar{调用接口：}
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
<URL>?imageView/<Mode>/w/<Width>/h/<Height>/q/<Quality>/format/<Format>
\end{lstlisting}

%\begin{verbatim}
%<URL>?imageView/<Mode>/w/<Width>/h/<Height>/q/<Quality>/format/<Format>
%     |________||_____||________||_________||__________||______________|
%          |       |        |         |           |            |
% 指示符 --+       |        |         |           |            |
%                  |        |         |           |            |
% 缩略模式 --------+        |         |           |            |
%                           |         |           |            |
% 缩略宽度（像素） ---------+         |           |            |
%                                     |           |            |
% 缩略高度（像素） -------------------+           |            |
%                                                 |            |
% 缩略质量（取值1-100） --------------------------+            |
%                                                              |
% 图片格式（支持jpg、gif、webp等） ----------------------------+
%\end{verbatim}

\qpar{参数说明：}
\qtable{
\def\arraystretch{2}
\begin{tabular}{|l|l|l|}
\hline
名称 & 说明 & 备注\\
\hline
\textless Mode\textgreater & 处理模式 & \\
\hline
\textless Width\textgreater & 缩略宽度，单位：像素（px） & \\
\hline
\textless Height\textgreater & 缩略高度，单位：像素（px） & \\
\hline
\textless Quality\textgreater & 图片质量，取值范围1－100 & 可选，缺省为85 \\
\hline
\textless Format\textgreater & 图片格式，支持jpg、gif、png、webp等 & 可选，缺省为原图格式 \\
\hline
\end{tabular}
}

\qpar{其中\textless mode\textgreater分为如下4种情况：}
\qtable{
\def\arraystretch{2}
\begin{tabular}{|l|p{22em}|l|}
\hline
模式 & 说明 & 备注 \\
\hline
\textless mode\textgreater=1 & 同时指定宽度和高度，等比裁剪原图正中部分并缩小为\textless width\textgreater x\textless height\textgreater 大小的缩略图。& 参看\hyperref[imageView-1-200x200]{示例\ref*{imageView-1-200x200}} \\
\hline
\textless mode\textgreater=2 & 同时指定宽度和高度，原图缩小为不超出\textless width\textgreater x\textless height\textgreater 大小的缩略图，避免裁剪长边。& 参看\hyperref[imageView-2-200x200]{示例\ref*{imageView-2-200x200}} \\
\hline
\textless mode\textgreater=2 & 仅指定宽度，高度等比缩小。 & 参看\hyperref[imageView-2-200x200]{示例\ref*{imageView-2-200x200}} \\
\hline
\textless mode\textgreater=2 & 仅指定高度，宽度等比缩小。 & 参看\hyperref[imageView-2-x200]{示例\ref*{imageView-2-x200}} \\
\hline
\end{tabular}
}

\clearpage

\begin{sample}
  \caption{裁剪正中部分，等比缩小生成200x200缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/1/w/200/h/200}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageView_1_200x200.jpg}
    \end{center}
  \label{imageView-1-200x200}
\end{sample}

\begin{sample}
  \caption{宽度固定为200px，高度等比缩小，生成200x133缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/w/200/h/200}}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/w/200}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageView_2_200x200.jpg}
    \end{center}
  \label{imageView-2-200x200}
\end{sample}

\begin{sample}
  \caption{高度固定为200px，宽度等比缩小，生成300x200缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageView/2/h/200}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageView_2_x200.jpg}
    \end{center}
  \label{imageView-2-x200}
\end{sample}

\clearpage

\section{高级图片处理}

\qpar{除了能方便地生成缩略图外，七牛云处理服务还提供其它高级图片处理功能，包括缩略、裁剪、旋转等等。}
\qpar{调用接口：}
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
<URL>?imageMogr/v2/auto-orient
                  /thumbnail/<ImageSize>
                  /gravity/<GravityType>
                  /crop/<ImageSizeAndOffset>
                  /quality/<Quality>
                  /rotate/<Degree>
                  /format/<Format>
\end{lstlisting}

\qpar{参数说明：}
\qtable{
\def\arraystretch{2}
\begin{tabular}{|l|p{18em}|p{10em}|}
\hline
名称 & 说明 & 备注\\
\hline
\textless ImageSize\textgreater & 参看\hyperref[thumbnail-spec]{缩略图规格说明表} & 可选，缺省为不缩略 \\
\hline
\textless GravityType\textgreater & 参看\hyperref[offset-spec]{位置偏移取值表}，只会影响其后的裁剪偏移 & 可选，缺省为左上角（NorthWest） \\
\hline
\textless ImageSizeAndOffset\textgreater & 参看\hyperref[crop-spec]{裁剪图规格说明表} & 可选，缺省为不裁剪 \\
\hline
\textless Quality\textgreater & 图片质量，取值范围1－100 & 可选，缺省为85 \\
\hline
\textless Degree\textgreater & 旋转角度，取值范围1－360 & 可选，缺省为不旋转 \\
\hline
\textless Format\textgreater & 图片格式，支持jpg、gif、png、webp等 & 可选，缺省为原图格式 \\
\hline
\end{tabular}
}

\qpar{位置偏移取值表：}
\qtable{
\label{offset-spec}
\begin{tabular}[t]{|l|c|r|}
\hline
\parbox[t][6em]{6em}{NorthWest} & \parbox[t][6em]{6em}{\makebox[6em][c]{North}} & \parbox[t][6em]{6em}{\makebox[6em][r]{NorthEast}} \\
\hline
\parbox[c][7em]{6em}{West} & \parbox[c][7em]{6em}{\makebox[6em][c]{Center}} & \parbox[c][7em]{6em}{\makebox[6em][r]{East}} \\
\hline
\parbox[b][6em]{6em}{SouthWest} & \parbox[b][6em]{6em}{\makebox[6em][c]{South}} & \parbox[b][6em]{6em}{\makebox[6em][r]{SouthEast}} \\
\hline
\end{tabular}
}

\clearpage

\qpar{缩略图规格说明表：}
\qtable{
\label{thumbnail-spec}
\begin{tabular}[t]{|l|p{22em}|p{5em}|}
\hline
规格 & 说明 & 示例 \\
\hline
!\textless Scale\textgreater p & 基于原图大小，按指定百分比缩放。取值范围0－1000 & \hyperref[imageMogr-thumbnail-75p]{示例\ref*{imageMogr-thumbnail-75p}} \\
\hline
!\textless Scale\textgreater px & 以百分比形式指定目标图片宽度，高度等比缩放。取值范围0－1000 & \hyperref[imageMogr-thumbnail-75p]{示例\ref*{imageMogr-thumbnail-75p}} \\
\hline
!x\textless Scale\textgreater p & 以百分比形式指定目标图片高度，宽度等比缩放。取值范围0－1000 & \hyperref[imageMogr-thumbnail-75p]{示例\ref*{imageMogr-thumbnail-75p}} \\
\hline
\textless Width\textgreater x & 指定目标图片宽度，高度等比缩放。取值范围0－10000 & \hyperref[imageMogr-thumbnail-700px]{示例\ref*{imageMogr-thumbnail-700px}} \\
\hline
x\textless Height\textgreater & 指定目标图片高度，宽度等比缩放。取值范围0－10000 & \hyperref[imageMogr-thumbnail-700px]{示例\ref*{imageMogr-thumbnail-700px}} \\
\hline
\textless Width\textgreater x\textless Height\textgreater & 限定长边，短边自适应缩放，将目标图片限制在指定宽高矩形内。取值范围0－10000 & \hyperref[imageMogr-thumbnail-300x300]{示例\ref*{imageMogr-thumbnail-300x300}} \\
\hline
!\textless Width\textgreater x\textless Height\textgreater r & 限定短边，长边自适应缩放，目标图片会延伸至指定宽高矩形外。取值范围0－10000 & \hyperref[imageMogr-thumbnail-200x200r]{示例\ref*{imageMogr-thumbnail-200x200r}} \\
\hline
\textless Width\textgreater x\textless Height\textgreater ! & 限定目标图片宽高值，忽略原图宽高比例，按照指定宽高值强行缩略，可能导致目标图片变形。取值范围0－10000 & \hyperref[imageMogr-thumbnail-200x300-force]{示例\ref*{imageMogr-thumbnail-200x300-force}} \\
\hline
\textless Width\textgreater x\textless Height\textgreater \textgreater & 当原图尺寸大于给定的宽度或高度时，按照给定宽高值缩小。取值范围0－10000 & \hyperref[imageMogr-thumbnail-200x300-greater]{示例\ref*{imageMogr-thumbnail-200x300-greater}} \\
\hline
\textless Width\textgreater x\textless Height\textgreater \textless & 当原图尺寸小于给定的宽度或高度时，按照给定宽高值放大。取值范围0－10000 &  \hyperref[imageMogr-thumbnail-700x600-less]{示例\ref*{imageMogr-thumbnail-700x600-less}} \\
\hline
\textless Area\textgreater @ & 按原图高宽比例等比缩放，缩放后的像素数量不超过指定值。取值范围0－10$^8$ & \hyperref[imageMogr-thumbnail-350000-at]{示例\ref*{imageMogr-thumbnail-350000-at}} \\
\hline
\end{tabular}
}

\begin{sample}
  \caption{生成480x320缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{等比缩小75\%}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/!75p}}
    \qpar{按原宽度75\%等比缩小}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/!75px}}
    \qpar{按原高度75\%等比缩小}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/!x75p}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_75p.jpg}
    \end{center}
  \label{imageMogr-thumbnail-75p}
\end{sample}

\begin{sample}
  \caption{生成700x467放大图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{指定新宽度为700px}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/700x}}
    \qpar{指定新高度为467px}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/x467}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_700px.jpg}
    \end{center}
  \label{imageMogr-thumbnail-700px}
\end{sample}

\begin{sample}
  \caption{限定长边，生成不超过300x300的缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/300x300}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_300x300.jpg}
    \end{center}
  \label{imageMogr-thumbnail-300x300}
\end{sample}

\begin{sample}
  \caption{限定短边，生成不小于200x200的缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/!200x200r}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_200x200r.jpg}
    \end{center}
  \label{imageMogr-thumbnail-200x200r}
\end{sample}

\begin{sample}
  \caption{强制生成200x300的缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/200x300!}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_200x300_force.jpg}
    \end{center}
  \label{imageMogr-thumbnail-200x300-force}
\end{sample}

\begin{sample}
  \caption{原图大于指定长宽矩形，按长边自动缩小为200x133缩略图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/200x300>}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_200x300_greater.jpg}
    \end{center}
  \label{imageMogr-thumbnail-200x300-greater}
\end{sample}

\begin{sample}
  \caption{原图小于指定长宽矩形，按长边自动拉伸为700x467放大图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/700x600<}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_700x600_less.jpg}
    \end{center}
  \label{imageMogr-thumbnail-700x600-less}
\end{sample}

\begin{sample}
  \caption{生成图的像素总数小于指定值}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/thumbnail/350000@}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_thumbnail_350000_at.jpg}
    \end{center}
  \label{imageMogr-thumbnail-350000-at}
\end{sample}

\qpar{裁剪图规格说明表：}
\qtable{
\label{crop-spec}
\begin{tabular}[t]{|l|p{22em}|p{5em}|}
\hline
规格 & 说明 & 示例 \\
\hline
\textless Width\textgreater x & 指定目标图片宽度，高度不变。取值范围0－10000 & \hyperref[imageMogr-crop-300x]{示例\ref*{imageMogr-crop-300x}} \\
\hline
x\textless Height\textgreater & 指定目标图片高度，宽度不变。取值范围0－10000 & \hyperref[imageMogr-crop-x200]{示例\ref*{imageMogr-crop-x200}} \\
\hline
\textless Width\textgreater x\textless Height\textgreater & 同时指定目标图片宽高。取值范围0－10000 & \hyperref[imageMogr-crop-300x300]{示例\ref*{imageMogr-crop-300x300}} \\
\hline
\end{tabular}
}

\begin{sample}
  \caption{生成300x427裁剪图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/crop/300x}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_crop_300x.jpg}
    \end{center}
  \label{imageMogr-crop-300x}
\end{sample}

\begin{sample}
  \caption{生成640x200裁剪图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/crop/x200}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_crop_x200.jpg}
    \end{center}
  \label{imageMogr-crop-x200}
\end{sample}

\begin{sample}
  \caption{生成300x300裁剪图}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg}}
    \qpar{$\Rightarrow$}
    \qpar{\qurl{http://qiniuphotos.qiniudn.com/gogopher.jpg?imageMogr/v2/crop/300x300}}

    \begin{center}
      \includegraphics[scale=0.65]{../pics/gogopher_imageMogr_crop_300x300.jpg}
    \end{center}
  \label{imageMogr-crop-300x300}
\end{sample}

\end{CJK*}

\end{document}
