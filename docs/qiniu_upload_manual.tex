\documentclass[11pt, oneside]{book}
\usepackage{geometry}
\geometry{a4paper}

\usepackage{amsmath}
\usepackage{xfrac}

\usepackage{graphicx}
\usepackage{indentfirst}
\usepackage[colorlinks,urlcolor=blue]{hyperref}

\usepackage{listings}
\lstset{basicstyle=\footnotesize}

\usepackage{float}
\usepackage[usenames,dvipsnames]{color}

\usepackage{fontspec, xunicode, xltxtra}
\setmainfont{Hiragino Sans GB W3}
%\setmainfont{Microsoft YaHei}
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt

\newcommand{\qhint}[1]{
\footnotesize
\vspace{0.2em}
\noindent
#1\par
\vspace{-0.5em}
\normalsize
}

\newcommand{\qsym}[1]{
\footnotesize
\noindent
#1\par
\normalsize
}

\newcommand{\qpara}[1]{
\vspace{0.3em}
\noindent
#1\par
\vspace{0.3em}
}

\newcommand{\qsamplelink}[1]{
\vspace{0.2em}
\noindent
#1\par
\vspace{0.1em}
}

\newcommand{\qurl}[1]{\footnotesize\url{#1}\normalsize}
\newcommand{\qqbox}[1]{\hspace{0.2em}\setlength{\fboxsep}{0.2em}\fcolorbox{black}{YellowGreen}{#1}\hspace{0.2em}}
\newcommand{\qtable}[1]{\footnotesize\vspace{0.5em}#1\vspace{0.5em}\normalsize}
\newcommand{\qsample}[1]{\hyperref[#1]{示例\ref*{#1}}}

\floatstyle{ruled}
\newfloat{sample}{H}{sample}[chapter]
\floatname{sample}{示例}

\setlength{\textheight}{680pt}

\title{七牛上传服务指南}
\author{梁涛 \\ @七牛云存储}
\date{2013-09-10}

\begin{document}

\maketitle
\tableofcontents

\chapter{术语}


\begin{itemize}
\item {\bf 资源}\par
\qhint{存入七牛云的数据体的统称，在有限前提下可与“文件”互换。}

\item {\bf 七牛云}\par
\qhint{所有对外放开的七牛服务及相关系统的统称，含云存储、云处理和云加速三大子系统。}
\qhint{本文通篇使用“七牛云”指代“七牛云存储子系统”这一实体。}

\item {\bf 业务服务器}\par
\qhint{七牛用户自建的、用于运行业务逻辑的服务器实体。}

\item {\bf 业务客户端}\par
\qhint{七牛用户的用户（即最终用户）、用于运行交互逻辑的客户端实体。}

\item {\bf 高速线路}\par
\qhint{机房（或IDC）之间使用的通信线路，具有低延迟（20～50毫秒）、极低丢包率、中间路由少或转发效率高、上下行带宽对等等特点。}
\qhint{注意：高速通信线路可能跨越不同运营商的异构网络。}

\item {\bf 低速线路}\par
\qhint{机房（或IDC）与业务客户端之间使用的通信线路，具有中等延迟（50～100毫秒）、低丢包率、偶发故障、偶发线路切换、上下行带宽不对等等特点。}

\item {\bf 客户端接入环境}\par
\qhint{业务客户端接入互联网的环境，常见的有LAN（局域网）、WLAN/Wi-Fi（无线局域网）、2G/3G（移动网）等。}
\qhint{注意：接入环境会随着客户端物理位置随时发生改变，如离开房屋导致从Wi-Fi环境切换到3G环境，跨越3G信号塔覆盖区域导致在不同的接入基站之间切换。}
\end{itemize}

\chapter{上传方式}

\section{直传}

\qpara{直传是最简单、最直观的上传方式，通过将单一资源封装在一次HTTP请求中传输至七牛云。}
\qpara{■\thinspace 优点：传输模型简单，API单一。}
\qpara{■\thinspace 缺点：对大型资源不友好，失败概率与资源大小成正比，纠错成本高（只能重传整个资源）。}
\qpara{■\thinspace 适用场景：大小固定的微型/小型资源上传、服务器之间资源传输。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/one_put.png}
\end{center}

\section{断点续上传（Block）}

\qpara{通过将资源切分为固定大小的数据块（称为Block，4MB大小），封装在多次HTTP请求中逐一传输至七牛云。}
\qpara{可根据实际需求灵活地调整为串行传输或并发传输。}
\qpara{■\thinspace 优点：对大型资源友好，纠错成本小（只重传失败的数据块）。}
\qpara{■\thinspace 缺点：传输模型复杂，API多。}
\qpara{■\thinspace 适用场景：大小固定的中型/大型资源上传，弱信号通信线路的上传，频繁切换接入点/线路的上传。}

\subsection{串行传输}

\qpara{断点续上传的串行传输与单一资源的直传类似，只是传输单元更小、纠错成本更小。相对地，多次HTTP请求会带来传输成本的上升。}
\qpara{■\thinspace 适用场景：出口（上行）带宽较小的环境，如家用ADSL接入线路。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/one_rput.png}
\end{center}

\qpara{虚线框：上传成功的数据范围。 \\ 实线框：可以读取的数据范围。}

\subsection{并发传输}

\qpara{断点续上传的并发传输与多资源的并发直传类似，用于加快单一大型资源的传输速度。}
\qpara{■\thinspace 适用场景：出口（上行）带宽较大的环境，如商业专用接入线路。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/one_rputl.png}
\end{center}

\subsection{细粒度传输（Chunk）}

\qpara{断点续上传的细粒度传输构建在对数据块的进一步切分之上，也即将数据块（Block）切分为非固定大小的数据片（称为Chunk，小于4MB），更灵活地贴合传输环境的限制，甚至智能调整传输速率以提供更好的用户体验。}
\qpara{每个数据片封装成一个HTTP请求，过小的数据片将带来额外的传输成本。另外数据片不能并发上传。}
\qpara{■\thinspace 适用场景：频繁切换接入点的环境，如地铁等信号弱、频繁重新接入网络的封闭空间。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/one_rput_chunk.png}
\end{center}

\section{追加上传（Append）}

\qpara{类似于操作系统打开文件时使用的Append参数，七牛云也提供相应语义的追加上传方式，在已保存文件的尾部追加数据。}
\qpara{本方式同样采用切分数据、逐一上传的思路，但与断点续上传不同的是a）只切分成非固定大小的数据片（Chunk），b）每个数据片上传后即可立刻读取 。}
\qpara{■\thinspace 优点：资源大小无限制，支持流式传输，支持即写即读。}
\qpara{■\thinspace 缺点：传输模型复杂，不支持并发上传。}
\qpara{■\thinspace 适用场景：流式资源的上传，如监控音频/视频流、直播视频流存储，无长度限制的日志。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/one_append.png}
\end{center}

\qpara{实线框：上传成功/可以读取的数据范围。}

\section{特性一览表}

\qtable{
\def\arraystretch{2}
\begin{tabular}{|l|p{10em}|p{10em}|p{10em}|}
\hline
特性 & 直传 & 断点续上传 & 追加上传 \\
\hline
API数量 & 1 & 3 & 3 \\
\hline
单次上传数据量 & 最大500MB & 最大4MB & 最大500MB \\
\hline
单个资源数据量 & 最大500MB & 无限制 & 无限制 \\
\hline
数据块并发上传 & ${\texttimes}$ & ${\surd}$ & ${\texttimes}$ \\
\hline
即传即读 & ${\texttimes}$ & ${\texttimes}$ & ${\surd}$ \\
\hline
\end{tabular}
}

\chapter{上传业务模型}

\qpara{七牛云存储提供多种上传业务模型，以满足不同业务场景的需求。用户可根据实际情况择优选用，使用七牛官方SDK开发上传模块或工具，或直接使用七牛官方上传工具。}

\section{本地上传模型}

\qpara{该模型适用于上传存储在本地计算机或服务器的资源。}
\qpara{■\thinspace 适用场景：资源直传、大批量迁移、定期备份。}
\qpara{■\thinspace 参与实体：七牛云、本地资源存储机。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/local_upload_direct.png}
\end{center}

\section{客户端通知上传模型（非HTML）}

\qpara{该模型适用于上传第三方产生的资源，并由第三方将上传结果通知给业务服务器。}
\qpara{■\thinspace 适用场景：用户产生内容（UGC）。}
\qpara{■\thinspace 参与实体：七牛云、业务客户端、业务服务器。}
\qpara{■\thinspace 潜在问题：1）上传过程与通知过程是分离的，任一过程失败都将导致业务状态不一致；2）上传过程与通知过程都可能走低速线路，带来不必要的延迟。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/ugc_upload_direct.png}
\end{center}

\section{七牛云通知上传模型}

\qpara{该模型同样适用于上传第三方产生的资源，只是改由七牛云将上传结果通知给业务服务器，并把最终结果返回给第三方。}
\qpara{■\thinspace 适用场景：用户产生内容（UGC）。}
\qpara{■\thinspace 参与实体：七牛云、业务客户端、业务服务器。}

\begin{center}
\includegraphics[scale=1]{../pics/upload/ugc_upload_callback.png}
\end{center}

\chapter{上传授权凭证}

\qpara{为防止恶意上传垃圾资源（消耗存储空间，引发额外计费），或篡改/损坏/伪造资源，每个上传请求都需要随附一份上传授权凭证（uploadToken），用于验证上传者与上传请求的合法性。同时，需要在该凭证内指定上传策略参数。}
\qpara{上传授权凭证通常由业务服务器签发，避免签名用的密钥泄露。}

\section{策略参数}

\qpara{■\thinspace 参数格式：\href{http://zh.wikipedia.org/wiki/JSON}{JSON}。}
\begin{lstlisting}
{
    "scope":        "<Bucket                   string>",
    "deadline":     <UnixTimestamp             int64>,
    "endUser":      "<EndUserId                string>",
    "returnUrl":    "<RedirectURL              string>",
    "returnBody":   "<ResponseBodyForAppClient string>",
    "callbackBody": "<RequestBodyForAppServer  string>",
    "callbackUrl":  "<RequestUrlForAppServer   string>",
    "asyncOps":     "<asyncProcessCmds         string>"
}
\end{lstlisting}

\begin{sample}
  \caption{uploadToken实例（覆盖语义）}
\begin{lstlisting}
{
    "scope":        "newdocs:qiniu_upload_manual.pdf",
    "deadline":     1379918153,
    "endUser":      "liangtao@qiniu.com"
}
\end{lstlisting}

  \label{uploadToken-overwrite}
\end{sample}

\qpara{■\thinspace 参数说明：}
\qtable{
\def\arraystretch{2}
\begin{tabular}{|l|p{25em}|p{8em}|}
\hline
名称 & 说明 & 备注 \\
\hline
scope & 指定存储目标 & 必填 \\
\cline{2-2}
      & "<Bucket>"：目标资源空间，如资源存在则\textcolor{red}{失败} & \\
\cline{2-2}
      & "<Bucket>:<Key>"：目标资源标识，如资源存在则\textcolor{red}{覆盖} & \\
\hline
deadline & 凭证失效期限，\href{http://en.wikipedia.org/wiki/Unix_time}{UNIX Epoch格式}（绝对时间），单位：秒 & 必填 \\
\hline
endUser & 唯一属主标识，用于特殊操作，如作为业务客户端标识，为图片或视频打水印 & \\
\hline
returnUrl & 指定上传成功后执行\href{http://en.wikipedia.org/wiki/HTTP_301}{HTTP 301转跳}的目标URL，多用于HTML表单上传场景。最终URL为<returnUrl>?<returnBody> & 不可与callbackUrl共用 \\
\hline
returnBody & 指定上传成功后返回七牛云给业务客户端返回的上传结果。支持魔法变量 & 不可与callbackBody共用 \\
\hline
callbackUrl & 指定上传成功后执行\href{http://en.wikipedia.org/wiki/POST_(HTTP)}{HTTP POST请求}的目标URL，多用于向业务服务器推送上传结果。必须是公网上能正常返回HTTP 200响应的URL & 不可与returnUrl共用 \\
\hline
callbackBody & 指定上传成功后推送的上传结果内容，支持魔法变量与自定义变量 & 不可与returnBody共用 \\
\hline
asyncOps & 指定上传成功后执行的异步预转指令，多个指令以分号（{\bf ;}）分隔 & \\
\hline
\end{tabular}
}

\section{签名算法}

\href{http://zh.wikipedia.org/wiki/Base64#.E5.9C.A8URL.E4.B8.AD.E7.9A.84.E5.BA.94.E7.94.A8}{URL友好的Base64（urlsafe\_base64）}

\chapter{API}

\section{直传}

\section{断点续上传}

\section{追加上传}

\qpara{待续……}

\chapter{FAQ}

\qpara{待续……}

\end{document}
